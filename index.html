<!-- index.html script block replacement -->
<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbx6wXBVIvIIoUptbsUAqXCr4lUxEKEELo83QBCIiiwE9zDnF1b4-RkGMKRiRc6MMinY/exec";
  const PRICE_PER_HOUR = 50;

  (function booking(){
    const dateEl = document.getElementById("bkDate");
    const slotsEl = document.getElementById("bkSlots");
    const submitBtn = document.getElementById("bkSubmit");
    const msgEl = document.getElementById("bkMsg");

    const firstEl = document.getElementById("bkFirst");
    const lastEl = document.getElementById("bkLast");
    const emailEl = document.getElementById("bkEmail");
    const phoneEl = document.getElementById("bkPhone");
    const igEl = document.getElementById("bkIg");
    const roomEl = document.getElementById("bkRoom");
    const notesEl = document.getElementById("bkNotes");

    // one hour slots, user selects a start and an end by selecting multiple consecutive slots
    const START_HOUR = 12; // 12 PM
    const END_HOUR = 22;   // 10 PM end, last start is 9 PM
    let busy = new Set();
    let selected = new Set();

    function todayISO(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return y + "-" + m + "-" + day;
    }

    function setMinDate(){
      const start = "2026-01-01";
      dateEl.min = start;
      const t = todayISO();
      dateEl.value = t < start ? start : t;
    }

    function timeLabel(h){
      const ap = h >= 12 ? "PM" : "AM";
      const hh = ((h + 11) % 12) + 1;
      return hh + ":00 " + ap;
    }

    function allTimes(){
      const out = [];
      for(let h = START_HOUR; h < END_HOUR; h++){
        out.push(timeLabel(h));
      }
      return out;
    }

    function parseHour(label){
      // "1:00 PM" -> 13
      const m = String(label).trim().match(/^(\d{1,2}):00\s*(AM|PM)$/i);
      if(!m) return null;
      let hh = Number(m[1]);
      const ap = m[2].toUpperCase();
      if(hh < 1 || hh > 12) return null;
      if(ap === "PM" && hh !== 12) hh += 12;
      if(ap === "AM" && hh === 12) hh = 0;
      return hh;
    }

    function selectionRange(){
      if(selected.size === 0) return null;
      const hours = Array.from(selected).map(parseHour).filter(v => v !== null).sort((a,b)=>a-b);
      if(hours.length === 0) return null;

      // must be consecutive
      for(let i=1;i<hours.length;i++){
        if(hours[i] !== hours[i-1] + 1) return null;
      }

      const startHour = hours[0];
      const endHour = hours[hours.length - 1] + 1;
      const durationHours = endHour - startHour;

      return { startHour, endHour, durationHours, hours };
    }

    function updateButtonFromSelection(){
      const range = selectionRange();
      if(!range){
        submitBtn.disabled = true;
        submitBtn.textContent = selected.size ? "select consecutive times" : "select time slots";
        return;
      }
      const total = range.durationHours * PRICE_PER_HOUR;
      submitBtn.disabled = false;
      submitBtn.textContent = "request booking ($" + total + ")";
    }

    function clearSelection(){
      selected.clear();
      document.querySelectorAll(".slotSelected").forEach(x => x.classList.remove("slotSelected"));
      updateButtonFromSelection();
    }

    function renderSlots(){
      slotsEl.innerHTML = "";
      clearSelection();
      msgEl.textContent = "";

      for(const t of allTimes()){
        const b = document.createElement("button");
        b.type = "button";
        b.className = "slot";
        b.textContent = t;

        if(busy.has(t)){
          b.classList.add("slotBooked");
          b.disabled = true;
        }

        b.addEventListener("click", ()=>{
          if(b.disabled) return;

          if(selected.has(t)){
            selected.delete(t);
            b.classList.remove("slotSelected");
          } else {
            selected.add(t);
            b.classList.add("slotSelected");
          }

          // enforce consecutive selection by auto clearing if it becomes non consecutive
          const range = selectionRange();
          if(selected.size > 0 && !range){
            msgEl.textContent = "pick times that connect, like 12 1 2 or 1 2 3";
            // keep the last clicked slot only
            document.querySelectorAll(".slotSelected").forEach(x => x.classList.remove("slotSelected"));
            selected.clear();
            selected.add(t);
            b.classList.add("slotSelected");
          } else {
            msgEl.textContent = "";
          }

          updateButtonFromSelection();
        });

        slotsEl.appendChild(b);
      }

      updateButtonFromSelection();
    }

    async function loadBusy(){
      busy = new Set();
      renderSlots();

      const date = dateEl.value;
      if(!date) return;

      if(!API_URL || API_URL.indexOf("PASTE_") === 0){
        msgEl.textContent = "backend not set yet";
        return;
      }

      try{
        const res = await fetch(API_URL + "?mode=busy&date=" + encodeURIComponent(date));
        const data = await res.json();
        if(data && data.ok && Array.isArray(data.busy)){
          busy = new Set(data.busy);
        }
      }catch(e){
        busy = new Set();
      }

      renderSlots();
    }

    function validate(){
      if(!firstEl.value.trim()) return "enter first name";
      if(!lastEl.value.trim()) return "enter last name";
      if(!emailEl.value.trim()) return "enter email";
      if(!phoneEl.value.trim()) return "enter phone";
      if(!igEl.value.trim()) return "enter instagram";
      if(!dateEl.value) return "pick a date";
      const range = selectionRange();
      if(!range) return "pick consecutive times";
      return "";
    }

    async function submit(){
      const err = validate();
      if(err){ msgEl.textContent = err; return; }

      if(!API_URL || API_URL.indexOf("PASTE_") === 0){
        msgEl.textContent = "backend not set yet";
        return;
      }

      const range = selectionRange();
      if(!range){
        msgEl.textContent = "pick consecutive times";
        return;
      }

      submitBtn.disabled = true;
      msgEl.textContent = "sending...";

      const fullName = firstEl.value.trim() + " " + lastEl.value.trim();
      const durationMinutes = range.durationHours * 60;
      const total = range.durationHours * PRICE_PER_HOUR;

      const payload = {
        name: fullName,
        email: emailEl.value.trim(),
        phone: phoneEl.value.trim(),
        instagram: igEl.value.trim(),
        date: dateEl.value,
        time: timeLabel(range.startHour),
        durationMinutes: String(durationMinutes),
        notes: [
          "price: $" + PRICE_PER_HOUR + " per hour",
          "total: $" + total,
          "hours booked: " + range.durationHours,
          "range: " + timeLabel(range.startHour) + " to " + timeLabel(range.endHour),
          "preferred room: " + String(roomEl.value),
          "",
          String(notesEl.value || "").trim()
        ].join("\n")
      };

      const params = new URLSearchParams();
      Object.entries(payload).forEach(([k,v]) => params.append(k, String(v)));

      try{
        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body: params.toString()
        });
        const data = await res.json();

        if(!data || !data.ok){
          msgEl.textContent = (data && data.error) ? data.error : "error, try again";
          submitBtn.disabled = false;
          return;
        }

        msgEl.textContent = "request sent. I will text you to confirm.";
        await loadBusy();
      }catch(e){
        msgEl.textContent = "error, try again";
        submitBtn.disabled = false;
      }
    }

    setMinDate();
    loadBusy();

    dateEl.addEventListener("change", loadBusy);
    submitBtn.addEventListener("click", submit);
  })();
</script>
